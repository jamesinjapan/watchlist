<%
# Libraries for JSON
require 'net/http' 
require 'json' 

movie_id = params[:m]

# Get JSON data from tmdb
url = "https://api.themoviedb.org/3/movie/" + movie_id + "?api_key=553017e076c2ecd01b7bf9cdd20a6360&append_to_response=keywords,credits,recommendations,similar,reviews"
uri = URI(url) 
response = Net::HTTP.get(uri)
m = JSON.parse(response) 

# Prepare plus sign glyphicon span
glyphicon_plus = "<span class='glyphicon glyphicon-plus' aria-hidden='true'></span> "

# Prepare poster array
tmdb_recommends = m["recommendations"]["results"] + m["similar"]["results"]
tmdb_recommends.sort! { |x,y| y["popularity"] <=> x["popularity"] }
tmdb_recommends.uniq! { |v| v["id"] }
tmdb_recommends.delete_if { |v| v["poster_path"] == nil } %>
<div class="container">
  <% if m["backdrop_path"] != nil %>
    <div class="jumbotron" style="background-image: url('https://image.tmdb.org/t/p/w1280<%= m["backdrop_path"] %>'); border-radius:0px;" >
      <div class="container">
        <%= render partial: "shared/movie_title_lookup" %>
        <h1><%= m["title"] %><br><small><%= m["tagline"] %></small></h1>
      </div>
    </div>
  <% else %>
    <div class="col-xs-12 page-header">
      <%= render partial: "shared/movie_title_lookup" %>
      <h1><%= m["title"] %><br><br><small><%= m["tagline"] %></small></h1>
    </div>
  <% end %>
  <div class="row">
    <div class="col-xs-12">
      <div class="col-xs-12 col-sm-6 movie-release-date">
        <div class="heading">Release date</div>
        <div class="content"><%= m["release_date"] %></div>
      </div>
      <div class="col-xs-12 col-sm-6 movie-runtime">
        <div class="heading">Runtime</div>
        <div class="content"><%= m["runtime"] %> minutes</div>
      </div>
      <div class="col-xs-12 movie-synopsis">
        <div class="heading">Synopsis</div>
        <div class="content"><%= m["overview"] %></div>
      </div>
    </div>
    <div id="recommendation-poster-carousel" class="col-xs-12 carousel slide" data-ride="carousel">
      <h3>If you liked <%= m["title"] %>, try:</h3>
      <!-- Wrapper for slides -->
      <div class="carousel-inner" role="listbox">
        <div class="item active">
          <% if m["poster_path"] == nil %>
            <%= image_tag('noposter')  %>
          <% else %>
            <%= image_tag "https://image.tmdb.org/t/p/w600" + m["poster_path"], :class => "img-responsive", :alt =>  "#{m["title"]} #{m["release_date"]}" %>
          <% end %>
        </div>
        <% tmdb_recommends.each_with_index do |v,i| %>
          <div class="item">
            <%= link_to image_tag("https://image.tmdb.org/t/p/w600" + v["poster_path"], :class => "img-responsive", :alt =>  "#{v["title"]} #{v["release_date"]}"), movie_index_path(:m => v["id"]) %>
          </div>
        <% end %>
      </div>
    
      <!-- Controls -->
      <a class="left carousel-control" href="#recommendation-poster-carousel" role="button" data-slide="prev">
        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
      </a>
      <a class="right carousel-control" href="#recommendation-poster-carousel" role="button" data-slide="next">
        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
      </a>
    </div>
    <div class="col-xs-12">
      <h4>Customize your recommendations by selecting filters below:</h4>
      <form action="<%= recommendation_index_path %>" method="get" id="recommendation-filter-form">
        <fieldset>
          <legend>Genres: </legend>
          <% m["genres"].each_with_index do |v,i| %>
              <label for="checkbox-genres-<%= i %>"><%= v["name"] %>
                <%= check_box_tag "g[]", v["id"], false, :class => 'checkbox-genres' %>
              </label>
          <% end %>
        </fieldset>
        <fieldset>
          <legend>Keywords: </legend>
          <% m["keywords"]["keywords"].each_with_index do |v,i| %>
            <label for="checkbox-keywords-<%= i %>"><%= v["name"] %>
              <%= check_box_tag "k[]", v["id"], false, :class => 'checkbox-keywords' %>
            </label>
          <% end %>
        </fieldset>
        <fieldset>
          <legend>Production Countries: </legend>
          <% m["production_countries"].each_with_index do |v,i| %>
            <label for="checkbox-production-countries-<%= i %>"><%= v["name"] %>
              <%= check_box_tag "pc[]", v["iso_3166_1"], false, :class => 'checkbox-production-countries' %>
            </label>
          <% end %>
        </fieldset>
        <fieldset>
          <legend>Spoken Languages: </legend>
          <% m["spoken_languages"].each_with_index do |v,i| %>
            <label for="checkbox-spoken-languages-<%= i %>"><%= v["name"] %>
              <%= check_box_tag "sl[]", v["iso_639_1"], false, :class => 'checkbox-spoken-languages' %>
            </label>
          <% end %>
        </fieldset>
        <fieldset>
          <legend>Crew: </legend>
          <% notable_crew = ["Director","Writer","Director of Photography","Original Music Composer","Stunt Coordinator"] 
             crew = [] 
             m["credits"]["crew"].each do |v| 
               if notable_crew.include?(v["job"])
                 crew.push("id" => v["id"], "name" => v["name"])
              end 
            end 
            crew.uniq.each_with_index do |v,i| %>
              <label for="checkbox-crew-<%= i %>"><%= v["name"] %>
                <%= check_box_tag "c[]", v["id"], false, :class => 'checkbox-crew' %>
              </label>
          <% end %>
        </fieldset>
        <fieldset>
          <legend>Cast: </legend>
          <% cast = []
             m["credits"]["cast"].each do |v| 
               cast.push("id" => v["id"], "name" => v["name"])
             end 
             cast.uniq.each_with_index do |v,i| %>
               <label for="checkbox-cast-<%= i %>"><%= v["name"] %>
                 <%= check_box_tag "c[]", v["id"], false, :class => 'checkbox-cast' %>
               </label>
             <% end %>
        </fieldset>
        <%= hidden_field_tag :m, m["id"], :id => "movie-id" %>
        <%= submit_tag "Get new recommendations", :class => "btn btn-primary", :name => nil %>
      </form>
    </div>
    <div class="col-xs-12">
      <div class="col-xs-12 movie-reviews">
        <div class="heading">Reviews</div>
        <div class="content">
          <% m["reviews"]["results"].each_with_index do |v,i| %>
            <p class="review_content bg-warning"><b>Review by <%=v["author"] %></b><br>
            <%= raw truncate(v["content"], :length => 1000, :separator => ' ') + " " %> 
            <%= link_to "(read more)" , v["url"] %></p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>