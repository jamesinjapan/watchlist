<%
# Libraries for JSON
require 'net/http' 
require 'json' 

movie_id = params["movie_id"]

# Get JSON data from tmdb
url = "https://api.themoviedb.org/3/movie/" + movie_id + "?api_key=553017e076c2ecd01b7bf9cdd20a6360&append_to_response=keywords,credits,recommendations,similar,reviews"
uri = URI(url) 
response = Net::HTTP.get(uri)
m = JSON.parse(response) 

# Prepare plus sign glyphicon span
glyphicon_plus = "<span class='glyphicon glyphicon-plus' aria-hidden='true'></span> "

# Prepare poster array
tmdb_recommends = m["recommendations"]["results"] + m["similar"]["results"]
tmdb_recommends.sort! { |x,y| y["popularity"] <=> x["popularity"] }
tmdb_recommends.uniq! { |v| v["id"] }
tmdb_recommends.delete_if { |v| v["poster_path"] == nil } %>
<div class="container">
  <% if m["backdrop_path"] != nil %>
    <div class="jumbotron" style="background-image: url('http://image.tmdb.org/t/p/w1280<%= m["backdrop_path"] %>'); border-radius:0px;" >
      <div class="container">
        <h1><%= m["title"] %><br><small><%= m["tagline"] %></small></h1>
      </div>
    </div>
  <% else %>
    <div class="col-xs-12 page-header">
      <h1><%= m["title"] %><br><br><small><%= m["tagline"] %></small></h1>
    </div>
  <% end %>
  <div class="row">
    <div class="col-xs-12">
      <div class="col-xs-12 col-sm-6 movie-release-date">
        <div class="heading">Release date</div>
        <div class="content"><%= m["release_date"] %></div>
      </div>
      <div class="col-xs-12 col-sm-6 movie-runtime">
        <div class="heading">Runtime</div>
        <div class="content"><%= m["runtime"] %> minutes</div>
      </div>
      <div class="col-xs-12 movie-synopsis">
        <div class="heading">Synopsis</div>
        <div class="content"><%= m["overview"] %></div>
      </div>
    </div>
    <div id="recommendation-poster-carousel" class="col-xs-12 col-sm-offset-1 col-sm-10 col-md-offset-0 col-md-8 carousel slide" data-ride="carousel">
      <h3>If you liked <%= m["title"] %>, try:</h3>
      <!-- Wrapper for slides -->
      <div class="carousel-inner" role="listbox">
        <div class="item active">
          <% if m["poster_path"] == nil %>
            <%= image_tag('noposter')  %>
          <% else %>
            <%= image_tag "https://image.tmdb.org/t/p/w600" + m["poster_path"], :class => "img-responsive", :alt =>  "#{m["title"]} #{m["release_date"]}" %>
          <% end %>
        </div>
        <% tmdb_recommends.each_with_index do |v,i| %>
          <div class="item">
            <%= link_to image_tag("https://image.tmdb.org/t/p/w600" + v["poster_path"], :class => "img-responsive", :alt =>  "#{v["title"]} #{v["release_date"]}"), movie_index_path(:movie_id => v["id"]) %>
          </div>
        <% end %>
      </div>
    
      <!-- Controls -->
      <a class="left carousel-control" href="#recommendation-poster-carousel" role="button" data-slide="prev">
        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
      </a>
      <a class="right carousel-control" href="#recommendation-poster-carousel" role="button" data-slide="next">
        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
      </a>
    </div>
    <div class="col-xs-12 col-md-4">
      <h3>Or customize your recommendations by selecting filters below:</h3>
      <div class="col-xs-12 movie-genres">
        <div class="heading">Genres</div>
        <div class="btn-group" data-toggle="buttons">
          <% m["genres"].each_with_index do |v,i| %>
            <%= button_tag raw(glyphicon_plus + v["name"]), class:"btn btn-primary" %> <!-- movie_index_path(:genre_id => v["id"]) -->
          <% end %>
        </div>
      </div>
      <div class="col-xs-12 movie-keywords">
        <div class="heading">Keywords</div>
        <div class="btn-group" data-toggle="buttons">
          <% m["keywords"]["keywords"].each_with_index do |v,i| %>
            <%= button_tag raw(glyphicon_plus + v["name"]), :class => "btn btn-primary" %> <!-- movie_index_path(:keyword_id => v["id"]) -->
          <% end %>
        </div>
      </div>
      <div class="col-xs-12 movie-production-companies">
        <div class="heading">Production Companies</div>
        <div class="btn-group" data-toggle="buttons">
          <% m["production_companies"].each_with_index do |v,i| %>
            <%= button_tag raw(glyphicon_plus + v["name"]), :class => "btn btn-primary" %> <!-- movie_index_path(:production_company_id => v["id"]) -->
          <% end %>
        </div>
      </div>
      <div class="col-xs-12 movie-production-countries">
        <div class="heading">Production Countries</div>
        <div class="btn-group" data-toggle="buttons">
          <% m["production_countries"].each_with_index do |v,i| %>
            <%= button_tag raw(glyphicon_plus + v["name"]), :class => "btn btn-primary" %> <!-- movie_index_path(:production_country_id => v["iso_3166_1"]) -->
          <% end %>
        </div>
      </div>
      <div class="col-xs-12 movie-languages">
        <div class="heading">Spoken languages</div>
        <div class="btn-group" data-toggle="buttons">
          <% m["spoken_languages"].each_with_index do |v,i| %>
              <%= button_tag raw(glyphicon_plus + v["name"]), :class => "btn btn-primary" %> <!-- movie_index_path(:language_id => v["iso_639_1"]) -->
          <% end %>
        </div>
      </div>
    </div>
    <div class="col-xs-12">
      <div class="col-xs-12 movie-crew">
        <div class="heading">Crew</div>
        <div class="btn-group" data-toggle="buttons">
          <% notable_crew = ["Director","Writer","Director of Photography","Original Music Composer","Stunt Coordinator"]
          m["credits"]["crew"].each_with_index do |v,i| %>
            <% if notable_crew.include?(v["job"]) %>
              <%= button_tag raw(glyphicon_plus + v["name"]), :class => "btn btn-primary" %> <!-- movie_index_path(:credits_id => v["id"]) -->
            <% end %>
          <% end %>
        </div>
      </div>
      <div class="col-xs-12 movie-cast">
        <div class="heading">Cast</div>
        <div class="btn-group" data-toggle="buttons">
          <% m["credits"]["cast"].each_with_index do |v,i| %>
            <%= button_tag raw(glyphicon_plus + v["name"]), :class => "btn btn-primary" %> <!-- movie_index_path(:credits_id => v["id"]) -->
          <% end %>
        </div>
      </div>
    </div>
    <div class="col-xs-12">
      <div class="col-xs-12 movie-reviews">
        <div class="heading">Reviews</div>
        <div class="content">
          <% m["reviews"]["results"].each_with_index do |v,i| %>
            <p class="review_content bg-warning"><b>Review by <%=v["author"] %></b><br>
            <%= raw truncate(v["content"], :length => 1000, :separator => ' ') + " " %> 
            <%= link_to "(read more)" , v["url"] %></p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>